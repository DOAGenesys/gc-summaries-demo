# Push GC summaries to external app

Web app to store and display all the AI summaries generated by Genesys Cloud Supervisor Copilot feature.

## Features

- **Secure Authentication**: Username/password login with HTTP-only session cookies
- **REST API**: POST endpoint to ingest conversation data with API key authentication
- **Database Storage**: Postgres database via Neon for persistent data storage
- **Modern UI**: Clean, professional interface with customizable branding
- **Responsive Design**: Fully responsive design that works on all devices
- **Detailed Views**: Click any conversation to see full details and insights
- **Real-time Stats**: Dashboard with conversation statistics and metrics
- **Hierarchical Summaries**: Group Agent/VirtualAgent summaries under parent Conversation summaries
- **Delete Functionality**: Delete summaries with cascade delete for parent conversations
- **Customizable Theming**: Configure logo and primary color via environment variables

## Tech Stack

- **Framework**: Next.js 16.1 (App Router, Server Components, Server Actions)
- **Language**: TypeScript
- **Database**: Neon Postgres with `@neondatabase/serverless`
- **Styling**: Tailwind CSS v4
- **UI Components**: Custom components built with Radix UI primitives
- **Deployment**: Vercel

## Prerequisites

- A Neon Postgres database (you can get a free test database directly from Vercel's "Storage" tab)
- Vercel account
- GitHub account (for deployment)

## Environment Variables

Configure the following environment variables in your Vercel project settings:

```env
# Database
DATABASE_URL=your_neon_database_connection_string

# Authentication
USERNAME=your_admin_username
PASSWORD=your_admin_password

# API Security
API_KEY=your_secure_api_key

# Customization (Optional)
LOGO_URL=https://example.com/your-logo.png
PRIMARY_COLOR=#0B6CFF
```

### Environment Variable Details

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `DATABASE_URL` | Yes | - | Neon Postgres connection string |
| `USERNAME` | Yes | - | Admin username for login |
| `PASSWORD` | Yes | - | Admin password for login |
| `API_KEY` | Yes | - | API key for POST endpoint authentication |
| `LOGO_URL` | No | - | URL to your logo image (supports external URLs) |
| `PRIMARY_COLOR` | No | `#0B6CFF` | Primary color in hex format for theming |

## Database Setup

Run the following SQL commands in your Neon database console or SQL editor to create all necessary tables and indexes:

```sql
-- Create conversations table to store all conversation summaries
CREATE TABLE IF NOT EXISTS conversations (
  id SERIAL PRIMARY KEY,
  summary_type VARCHAR(50) NOT NULL,
  media_type VARCHAR(50) NOT NULL,
  language VARCHAR(10) NOT NULL,
  summary_id VARCHAR(255) UNIQUE NOT NULL,
  agent_id VARCHAR(255),
  source_id VARCHAR(255) NOT NULL,
  summary TEXT NOT NULL,
  generated BOOLEAN DEFAULT true,
  date_created TIMESTAMP NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  conversation_id VARCHAR(255)
);

-- Create insights table to store conversation insights
CREATE TABLE IF NOT EXISTS insights (
  id SERIAL PRIMARY KEY,
  conversation_id INTEGER REFERENCES conversations(id) ON DELETE CASCADE,
  type VARCHAR(50) NOT NULL,
  title TEXT NOT NULL,
  description TEXT NOT NULL,
  outcome VARCHAR(100),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Create indexes for better query performance
CREATE INDEX IF NOT EXISTS idx_conversations_summary_type ON conversations(summary_type);
CREATE INDEX IF NOT EXISTS idx_conversations_date_created ON conversations(date_created DESC);
CREATE INDEX IF NOT EXISTS idx_conversations_summary_id ON conversations(summary_id);
CREATE INDEX IF NOT EXISTS idx_conversations_conversation_id ON conversations(conversation_id);
CREATE INDEX IF NOT EXISTS idx_insights_conversation_id ON insights(conversation_id);
```

### Verify Tables

After running the setup, verify the tables were created successfully:

```sql
-- Check tables
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'public';

-- Check conversations table structure
\d conversations

-- Check insights table structure
\d insights
```

## Deployment to Vercel

This application is designed to be deployed exclusively on Vercel.

1. **Push your code to GitHub**

2. **Connect to Vercel**:
   - Go to [vercel.com](https://vercel.com)
   - Import your GitHub repository
   - Vercel will auto-detect Next.js

3. **Set up your Neon database**:
   - In your Vercel project, go to the "Storage" tab
   - Click "Create Database" and select "Neon Postgres"
   - Vercel will automatically provision a free Neon database and set the `DATABASE_URL` environment variable
   - Alternatively, you can use an existing Neon database by manually adding the `DATABASE_URL`

4. **Run the database setup**:
   - Once the database is created, run the SQL initialization script from the Database Setup section in your Neon console

5. **Add remaining environment variables** in Vercel dashboard:
   - Go to Project Settings → Environment Variables
   - Add: `USERNAME`, `PASSWORD`, `API_KEY`
   - Optionally add `LOGO_URL` and `PRIMARY_COLOR` for custom branding

6. **Deploy**:
   - Vercel will automatically deploy your app
   - Your app will be available at `https://your-app.vercel.app`

## Security Features

- **Authentication**: Secure login with HTTP-only cookies
- **API Authentication**: API key validation for all POST requests
- **Session Management**: Server-side session handling
- **SQL Injection Prevention**: Parameterized queries with Neon driver
- **Environment Variables**: Sensitive data stored securely
- **HTTPS**: Automatic HTTPS on Vercel

### POST /api/conversations

Ingests new conversation summaries into the system.

**Headers:**
```
x-api-key: your_api_key
Content-Type: application/json
```

**Request Body:**
```json
{
  "entities": [
    {
      "summaryType": "Agent",
      "mediaType": "Call",
      "language": "es",
      "summaryId": "a8c57610-a162-3aff-9c23-8d83c930aa5e",
      "agentId": "b7f09b48-a686-4690-b2d4-b9e4e3b554d9",
      "sourceId": "5827d8b9-2223-4376-a191-b3d4fbec752f",
      "summary": "Customer contacted regarding Movistar Fusion package details...",
      "generated": true,
      "dateCreated": "2025-12-18T15:12:59.690Z",
      "conversationId": "parent-conversation-summary-id"
    }
  ]
}
```

**Response (Success):**
```json
{
  "success": true,
  "inserted": 1,
  "conversations": [
    {
      "id": 123,
      "summaryId": "a8c57610-a162-3aff-9c23-8d83c930aa5e"
    }
  ]
}
```

**Response (Unauthorized):**
```json
{
  "error": "Unauthorized"
}
```

### Summary Type Hierarchy

The `summaryType` field supports three values that form a hierarchy:

| Type | Description | conversationId Required |
|------|-------------|------------------------|
| `Conversation` | Parent summary representing the entire conversation | No |
| `Agent` | Summary for a human agent portion | Yes (must match parent's summaryId) |
| `VirtualAgent` | Summary for a virtual agent/bot portion | Yes (must match parent's summaryId) |

**Hierarchy Rules:**
- `Conversation` summaries act as parent containers
- `Agent` and `VirtualAgent` summaries must include `conversationId` matching the parent's `summaryId`
- Deleting a `Conversation` parent will cascade delete all associated child summaries
- In the UI, child summaries are displayed nested under their parent with a collapsible interface

### Example: Complete Conversation with Children

```json
{
  "entities": [
    {
      "summaryType": "Conversation",
      "mediaType": "Call",
      "language": "es",
      "summaryId": "conv-001",
      "sourceId": "source-123",
      "summary": "Complete conversation about Movistar Fusion package upgrade...",
      "generated": true,
      "dateCreated": "2025-12-18T15:13:30.457Z",
      "insights": [
        {
          "type": "Reason",
          "title": "Package upgrade inquiry",
          "description": "Customer wants to upgrade their current plan"
        }
      ]
    },
    {
      "summaryType": "VirtualAgent",
      "mediaType": "Call",
      "language": "es",
      "summaryId": "va-001",
      "sourceId": "source-123",
      "summary": "Virtual agent greeted customer and collected initial information...",
      "generated": true,
      "dateCreated": "2025-12-18T15:10:00.000Z",
      "conversationId": "conv-001"
    },
    {
      "summaryType": "Agent",
      "mediaType": "Call",
      "language": "es",
      "summaryId": "agent-001",
      "agentId": "agent-uuid",
      "sourceId": "source-123",
      "summary": "Human agent took over and processed the upgrade request...",
      "generated": true,
      "dateCreated": "2025-12-18T15:12:00.000Z",
      "conversationId": "conv-001"
    }
  ]
}
```

### Example with Insights

```json
{
  "entities": [
    {
      "summaryType": "Conversation",
      "mediaType": "Call",
      "language": "es",
      "summaryId": "2055a9b1-9bd1-429d-b2f9-81d34eeb7754",
      "sourceId": "cfabd884-161b-4de6-a014-fe202d9bb2c7",
      "summary": "Customer inquiry about Movistar Fusion package...",
      "generated": true,
      "dateCreated": "2025-12-18T15:13:30.457Z",
      "insights": [
        {
          "type": "Reason",
          "title": "Information about Movistar Fusion package",
          "description": "Customer wants to know the details of the package..."
        },
        {
          "type": "Resolution",
          "title": "Missing information",
          "description": "Customer still has questions about specific details...",
          "outcome": "Partially resolved"
        },
        {
          "type": "ActionItem",
          "title": "Follow-up needed",
          "description": "Agent should provide detailed information..."
        }
      ]
    }
  ]
}
```

### cURL Examples

**Post a parent Conversation summary:**
```bash
curl -X POST https://your-app.vercel.app/api/conversations \
  -H "x-api-key: your_api_key" \
  -H "Content-Type: application/json" \
  -d '{
    "entities": [
      {
        "summaryType": "Conversation",
        "mediaType": "Call",
        "language": "en",
        "summaryId": "conv-123",
        "sourceId": "source-abc",
        "summary": "Complete customer service interaction about billing inquiry.",
        "generated": true,
        "dateCreated": "2025-12-23T10:36:52.718Z"
      }
    ]
  }'
```

**Post child summaries linked to a parent:**
```bash
curl -X POST https://your-app.vercel.app/api/conversations \
  -H "x-api-key: your_api_key" \
  -H "Content-Type: application/json" \
  -d '{
    "entities": [
      {
        "summaryType": "Agent",
        "mediaType": "Call",
        "language": "en",
        "summaryId": "agent-456",
        "agentId": "agent-uuid",
        "sourceId": "source-abc",
        "summary": "Agent resolved the billing discrepancy.",
        "generated": true,
        "dateCreated": "2025-12-23T10:40:00.000Z",
        "conversationId": "conv-123"
      },
      {
        "summaryType": "VirtualAgent",
        "mediaType": "Call",
        "language": "en",
        "summaryId": "va-789",
        "sourceId": "source-abc",
        "summary": "Virtual agent collected customer information.",
        "generated": true,
        "dateCreated": "2025-12-23T10:35:00.000Z",
        "conversationId": "conv-123"
      }
    ]
  }'
```

## Data Schema

### Conversation Entity

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `summaryType` | string | Yes | Type of summary: `Conversation`, `Agent`, or `VirtualAgent` |
| `mediaType` | string | Yes | Media type: `Call`, `Email`, `Message`, or `Unknown` |
| `language` | string | Yes | Language code (e.g., `es`, `en`) |
| `summaryId` | string | Yes | Unique identifier for the summary |
| `agentId` | string | No | Agent identifier (only for Agent summaries) |
| `sourceId` | string | Yes | Source program/flow identifier |
| `summary` | string | Yes | Summary text of the conversation |
| `generated` | boolean | Yes | Whether summary was AI-generated |
| `dateCreated` | string | Yes | ISO-8601 timestamp |
| `conversationId` | string | Conditional | Parent conversation's summaryId (required for Agent/VirtualAgent) |
| `insights` | array | No | Array of insight objects |

### Insight Object

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `type` | string | Yes | Insight type: `Reason`, `Resolution`, or `ActionItem` |
| `title` | string | Yes | Insight title |
| `description` | string | Yes | Detailed description |
| `outcome` | string | No | Resolution outcome (for Resolution type) |

## Deployment to Vercel

1. **Push your code to GitHub**

2. **Connect to Vercel**:
   - Go to [vercel.com](https://vercel.com)
   - Import your GitHub repository
   - Vercel will auto-detect Next.js

3. **Add environment variables** in Vercel dashboard:
   - Go to Project Settings → Environment Variables
   - Add `DATABASE_URL`, `USERNAME`, `PASSWORD`, `API_KEY`
   - Optionally add `LOGO_URL` and `PRIMARY_COLOR` for custom branding

4. **Deploy**:
   - Vercel will automatically deploy your app
   - Your app will be available at `https://your-app.vercel.app`

## Security Features

- **Authentication**: Secure login with HTTP-only cookies
- **API Authentication**: API key validation for all POST requests
- **Session Management**: Server-side session handling
- **SQL Injection Prevention**: Parameterized queries with Neon driver
- **Environment Variables**: Sensitive data stored securely
- **HTTPS**: Automatic HTTPS on Vercel

## Project Structure

```
├── app/
│   ├── actions/
│   │   ├── auth.ts              # Server actions for auth
│   │   └── conversations.ts     # Server actions for conversation operations
│   ├── api/
│   │   └── conversations/
│   │       └── route.ts         # API endpoint
│   ├── conversation/
│   │   └── [id]/
│   │       └── page.tsx         # Detail view
│   ├── login/
│   │   └── page.tsx             # Login page
│   ├── globals.css              # Global styles
│   ├── layout.tsx               # Root layout
│   └── page.tsx                 # Dashboard
├── components/
│   ├── conversation-card.tsx    # Conversation card with grouping
│   ├── delete-button.tsx        # Delete button with confirmation
│   ├── language-switcher.tsx    # Language selector component
│   └── ui/                      # Reusable UI components
├── lib/
│   ├── auth.ts                  # Auth utilities
│   ├── db.ts                    # Database client
│   ├── env.ts                   # Environment configuration
│   ├── i18n.ts                  # Internationalization
│   ├── locale.ts                # Locale detection
│   ├── types.ts                 # TypeScript types
│   └── utils.ts                 # Utility functions
├── public/
│   └── movistar-logo.png        # Default logo
├── scripts/
│   └── init-database.sql        # Complete database initialization
└── README.md                    # This file
```

## Troubleshooting

### Cannot connect to database
- Verify `DATABASE_URL` is correct in Vercel environment variables
- Check that your Neon database is running
- Ensure IP allowlisting is configured in Neon (if applicable)

### Authentication not working
- Verify `USERNAME` and `PASSWORD` are set in Vercel environment variables
- Clear browser cookies and try again
- Check that cookies are enabled in your browser

### API returns 401 Unauthorized
- Verify the `x-api-key` header matches your `API_KEY` environment variable
- Ensure the header name is exactly `x-api-key` (case-sensitive)

### API returns 400 Bad Request for Agent/VirtualAgent
- Ensure `conversationId` is included in the request
- The `conversationId` should match the `summaryId` of a parent `Conversation` summary

### Tables don't exist
- Run the SQL initialization script in your Neon database
- Verify tables were created: `SELECT * FROM conversations LIMIT 1;`

### Logo not loading
- If using external URL, ensure it's publicly accessible
- Check that the URL is correctly formatted in `LOGO_URL`
- For local logos, ensure the file exists in the `public/` directory

### Colors not updating
- Ensure `PRIMARY_COLOR` is in valid hex format (e.g., `#FF5500`)
- The `#` prefix is optional but recommended

## Support

This is just a blueprint, provided as-is.
